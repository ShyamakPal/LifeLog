<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Life Log</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" type="text/css" />
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body>
        <h1>LIFE LOG</h1>
        
        <div class="log-container">
            <textarea id="logInput" placeholder="Write your daily log entry here..."></textarea>
            <button class="log-button" id="logButton">LOG</button>
        </div>
        
        <div class="success-message" id="successMessage">
            Log entry saved successfully!
        </div>
        
        <!-- Chatbot Section -->
        <div class="chatbot-section">
            <div class="controls">
                <h2>AI Insights</h2>
                <button class="toggle-chat" id="toggleChat">Show/Hide Chatbot</button>
            </div>
            <div class="chatbot-container" id="chatbotContainer">
                <div class="chat-messages" id="chatMessages">
                    <div class="bot-message">
                        Hello! I'm your Life Log Assistant. Ask me about your habits, patterns, or for summaries of your logs.
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Ask me anything about your logs...">
                    <button id="sendButton">Send</button>
                </div>
                <div class="model-selector">
                    <label for="aiModel">AI Model:</label>
                    <select id="aiModel">
                        <option value="bedrock">Amazon Bedrock</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="logs-section">
            <div class="controls">
                <h2>Previous Logs</h2>
                <button class="toggle-logs" id="toggleLogs">Show/Hide Logs</button>
            </div>
            <div id="previousLogs"></div>
        </div>
        <script>
            // Initialize event listeners when the page loads
            window.onload = function() {
                const logInput = document.getElementById('logInput');
                const logButton = document.getElementById('logButton');
                const previousLogs = document.getElementById('previousLogs');
                const successMessage = document.getElementById('successMessage');
                const toggleLogsButton = document.getElementById('toggleLogs');
                const chatInput = document.getElementById('chatInput');
                const sendButton = document.getElementById('sendButton');
                const chatMessages = document.getElementById('chatMessages');
                const toggleChatButton = document.getElementById('toggleChat');
                const chatbotContainer = document.getElementById('chatbotContainer');
                const aiModelSelect = document.getElementById('aiModel');
                
                let logsVisible = true;
                let chatVisible = true;
                
                // Load existing logs
                displayLogs();
                
                // Log button event listener
                logButton.addEventListener('click', function() {
                    const logText = logInput.value.trim();
                    
                    if (logText === '') {
                        alert('Please enter a log entry before saving.');
                        return;
                    }
                    
                    // Save the log entry
                    saveLog(logText);
                    
                    // Clear the input
                    logInput.value = '';
                    
                    // Show success message
                    successMessage.style.display = 'block';
                    setTimeout(function() {
                        successMessage.style.display = 'none';
                    }, 3000);
                    
                    // Refresh the displayed logs
                    displayLogs();
                });
                
                // Toggle logs visibility
                toggleLogsButton.addEventListener('click', function() {
                    logsVisible = !logsVisible;
                    previousLogs.style.display = logsVisible ? 'block' : 'none';
                });
                
                // Toggle chatbot visibility
                toggleChatButton.addEventListener('click', function() {
                    chatVisible = !chatVisible;
                    chatbotContainer.style.display = chatVisible ? 'block' : 'none';
                });
                
                // Send button event listener
                sendButton.addEventListener('click', function() {
                    sendChatMessage();
                });
                
                // Chat input keypress event listener (for Enter key)
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
                
                // Function to send chat message to AI
                function sendChatMessage() {
                    const message = chatInput.value.trim();
                    if (message === '') return;
                    
                    // Display user message
                    appendMessage('user', message);
                    
                    // Clear input
                    chatInput.value = '';
                    
                    // Get selected AI model (always bedrock now)
                    const selectedModel = "bedrock";
                    
                    // Get logs for context
                    let logs = [];
                    try {
                        logs = JSON.parse(localStorage.getItem('lifeLogs')) || [];
                    } catch (e) {
                        logs = [];
                    }
                    
                    // Show loading indicator
                    const loadingMsgId = 'loading-' + Date.now();
                    appendMessage('bot', 'Thinking...', loadingMsgId);
                    
                    // Send to backend API
                    fetch('https://by36wz5945.execute-api.us-west-2.amazonaws.com/prod/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            logs: logs,
                            model: selectedModel,
                            bucket: "lifelog-uci-2" // Add bucket name explicitly
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Remove loading message
                        document.getElementById(loadingMsgId)?.remove();
                        
                        // Display bot response
                        appendMessage('bot', data.response);
                    })
                    .catch(error => {
                        // Remove loading message
                        document.getElementById(loadingMsgId)?.remove();
                        
                        // Display error message
                        appendMessage('bot', 'Sorry, there was an error processing your request. Please try again later.');
                        console.error('Error:', error);
                    });
                }
                
                // Function to append message to chat
                function appendMessage(sender, text, id = null) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = sender === 'user' ? 'user-message' : 'bot-message';
                    if (id) messageDiv.id = id;
                    messageDiv.textContent = text;
                    chatMessages.appendChild(messageDiv);
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Function to save log to localStorage
                function saveLog(text) {
                    const now = new Date();
                    const logEntry = {
                        date: now.toISOString(),
                        text: text
                    };
                    
                    // Get existing logs
                    let logs = [];
                    try {
                        logs = JSON.parse(localStorage.getItem('lifeLogs')) || [];
                    } catch (e) {
                        logs = [];
                    }
                    
                    // Add new log at the beginning
                    logs.unshift(logEntry);
                    
                    // Save to localStorage
                    localStorage.setItem('lifeLogs', JSON.stringify(logs));
                }
                
                // Function to display logs from localStorage
                function displayLogs() {
                    // Get logs from localStorage
                    let logs = [];
                    try {
                        logs = JSON.parse(localStorage.getItem('lifeLogs')) || [];
                    } catch (e) {
                        logs = [];
                    }
                    
                    // Clear the container
                    previousLogs.innerHTML = '';
                    
                    if (logs.length === 0) {
                        previousLogs.innerHTML = '<div class="no-logs">No log entries yet. Start logging to see your entries here.</div>';
                        return;
                    }
                    
                    // Display each log
                    logs.forEach(log => {
                        const logDate = new Date(log.date);
                        const formattedDate = logDate.toLocaleDateString() + ' ' + logDate.toLocaleTimeString();
                        
                        const logElement = document.createElement('div');
                        logElement.className = 'log-entry';
                        
                        const dateElement = document.createElement('div');
                        dateElement.className = 'log-date';
                        dateElement.textContent = formattedDate;
                        
                        const textElement = document.createElement('div');
                        textElement.className = 'log-text';
                        textElement.textContent = log.text;
                        
                        logElement.appendChild(dateElement);
                        logElement.appendChild(textElement);
                        
                        previousLogs.appendChild(logElement);
                    });
                }
            };
        </script>
    </body>
</html>